version: '3.8'

services:
  image-api:
    runtime: nvidia
    privileged: true
    build:
      context: .
      dockerfile: Dockerfile
    container_name: image-generation-api
    # Run the container processes using the host UID/GID so files created in the bind-mounted
    # ./output-dir are owned by the host user and accessible via SFTP/FileZilla.
    environment:
      # Java Options
      JAVA_OPTS: "-Xms512m -Xmx1024m"
      # These can be set in a .env file (see README) or exported before running compose
      LOCAL_UID: "${LOCAL_UID:-1000}"
      LOCAL_GID: "${LOCAL_GID:-1000}"
      NVIDIA_VISIBLE_DEVICES: all
      NVIDIA_DRIVER_CAPABILITIES: compute,utility
    ports:
      - "8001:8080"
    restart: unless-stopped
    # Run container processes using the host user's UID:GID so created files are readable
    # by that same host user (useful for SFTP/FileZilla). Set LOCAL_UID/LOCAL_GID in a .env file
    # or export them in the shell before running `docker compose`.
    user: "${LOCAL_UID:-1000}:${LOCAL_GID:-1000}"
    command: ["java", "-jar", "app.jar"]
    volumes:
      - ./data:/app/data:ro
      - ./output-dir:/app/output-dir
      - /sys:/sys:ro
      - /dev:/dev
